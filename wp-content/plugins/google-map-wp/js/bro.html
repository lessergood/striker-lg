<!DOCTYPE html>
<html>
<head>
    <script src="jquery.js"></script>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>
    <title>Draggable directions</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
            float: left;
            width: 63%;
            height: 100%;
        }
        #right-panel {
            float: right;
            width: 34%;
            height: 100%;
        }
        #right-panel {
            font-family: 'Roboto','sans-serif';
            line-height: 30px;
            padding-left: 10px;
        }

        #right-panel select, #right-panel input {
            font-size: 15px;
        }

        #right-panel select {
            width: 100%;
        }

        #right-panel i {
            font-size: 12px;
        }

        .panel {
            height: 100%;
            overflow: auto;
        }

    </style>
</head>
<body>
<p>Change marker</p>

<h2 id="inf_mark_1"></h2>
<h2 id="inf_mark_2"></h2>

<hr>

<h2 id="drag_1"></h2>
<h2 id="drag_2"></h2>

<div id="map"></div>
<div id="right-panel">
    <p>Total Distance: <span id="total"></span></p>
</div>
<script>

    var markers = [];

    function initMap() {
        var mark_center = {lat: 40.17290549376247, lng: 44.51387107372284};

        var mapOptions = {
            center: mark_center,
            scrollwheel: true,
            zoom: 16
        }

        var map = new google.maps.Map(document.getElementById('map'),mapOptions)

        // Add a listener for the click event

        var mark1 = '';
        var mark2 = '';


        var title_num = 1;

        map.addListener('rightclick', addLatLng);

        //ADD MARKER AND DIRECTIONS

        function addLatLng(event) {

            if(mark2 != ''){ return false }

            // Sets the map on all markers in the array.

            if(mark1 == ''){

                //var path = poly.getPath();
                var latinf1 = event.latLng.lat()
                var lnginf1 = event.latLng.lng()
                //path.push(event.latLng);
                var marker1 = new google.maps.Marker({
                    draggable: true,
                    position: event.latLng,
                    title: '#' + title_num++,
                    map: map
                });
                markers.push(marker1);

                mark1 = {lat: latinf1, lng: lnginf1};
                document.getElementById('inf_mark_1').innerText = latinf1 + " - " + lnginf1

                google.maps.event.addListener(marker1, "drag", function (event) {
                    console.log(event)
                    var latinf1 = event.latLng.lat()
                    var lnginf1 = event.latLng.lng()
                    var title = this.getTitle();
                    var index = title.replace("#", "")
                    var position = this.getPosition();
                    mark1 = {lat: latinf1, lng: lnginf1};
                    document.getElementById('inf_mark_1').innerText = latinf1 + " - " + lnginf1

                    /*
                     polylineeditcoords[index] = position;
                     polylineedit.setPath(polylineeditcoords);
                     updatePolylineEditInputs();
                     console.log(polylineeditmarker)*/
                })
            }
            else{

                //var path = poly.getPath();
                var latinf2 = event.latLng.lat()
                var lnginf2 = event.latLng.lng()
                //path.push(event.latLng);
                var marker2 = new google.maps.Marker({
                    draggable: true,
                    position: event.latLng,
                    title: '#' + title_num++,
                    map: map
                });
                markers.push(marker2);

                // Deletes all markers

                clearMarkers();
                markers = [];

                mark2 = {lat: latinf2, lng: lnginf2};
                document.getElementById('inf_mark_2').innerText = latinf2 + " - " + lnginf2
                map_add_and_reload();

            }
        }


        function map_add_and_reload(){
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer({
                polylineOptions: {
                    strokeColor: "black",
                    strokeOpacity: 0.5,
                    strokeWeight: 10,
                    clickable: false,
                },
                map: map,
                draggable: true,
                panel: document.getElementById('right-panel')
            });
            // Set destination, origin and travel mode.
            var request = {
                destination: mark2,
                origin: mark1,
                travelMode: google.maps.TravelMode.DRIVING
            };
            console.log(request);
            // Pass the directions request to the directions service.
            var directionsService = new google.maps.DirectionsService();
            directionsService.route(request, function(response, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                    // Display the route on the map.
                    directionsDisplay.setDirections(response);
                }
            });
            console.log(directionsService);

            directionsDisplay.addListener('directions_changed', function() {
                computeTotalDistance(directionsDisplay.getDirections());
            });

        }

        function setMapOnAll(map) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

        // Removes the markers from the map, but keeps them in the array.
        function clearMarkers() {
            setMapOnAll(null);
        }

        function computeTotalDistance(result) {

            //console.log(result.routes[0].legs[0].end_location.lat())

            var start_lat = result.routes[0].legs[0].start_location.lat()
            var start_lng = result.routes[0].legs[0].start_location.lng()


            var end_lat = result.routes[0].legs[0].end_location.lat()
            var end_lng = result.routes[0].legs[0].end_location.lng()

            //START------------------------------------------------------------------------
            //console.log(start_lat)
            //console.log(start_lng)
            document.getElementById('inf_mark_1').innerText = start_lat + " - " + start_lng

            //END--------------------------------------------------------------------------
            //console.log(end_lat)
            //console.log(end_lng)
            document.getElementById('inf_mark_2').innerText = end_lat + " - " + end_lng

            //document.getElementById('drag1').innerText = drag1_lat + " - " + drag1_lng
            //document.getElementById('drag2').innerText = latinf1 + " - " + lnginf1
            // total = total / 1000;
            // document.getElementById('total').innerHTML = total + ' km';
        }



    }


</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCxPmoPgMubDwlujGbAy64RtOMSLc_LKE0&signed_in=true&callback=initMap"async defer></script>



</body>
</html>